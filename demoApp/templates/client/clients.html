{% extends "base.html" %}
{% load static %}

{% block title %}Clients{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clients.css' %}">
{% endblock %}

{% block content %}
<div class="page-wrapper" id="pageWrapper">

    <!-- ZONE GAUCHE : TABLEAU -->
    <div class="page-main" id="pageMain">

        <!-- Header page -->
        <div class="page-header">
            <div class="page-header-left">
                <h1 class="page-title">Clients</h1>
                <span class="page-count">{{ clients|length }} client{{ clients|length|pluralize }}</span>
            </div>
            <div class="page-header-right">
                <div class="search-box">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Rechercher un client...">
                </div>
                <button class="btn btn-primary" data-modal-target="#modalClient">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Nouveau client
                </button>
            </div>
        </div>

        <!-- Tableau -->
        <div class="table-container">
            <table class="table" id="clientsTable">
                <thead>
                    <tr>
                        <th class="th-sortable" data-sort="name">
                            Client
                            <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7-7 7 7"/></svg>
                        </th>
                        <th>Email</th>
                        <th>Téléphone</th>
                        <th>Adresse</th>
                        <th>Demandes</th>
                        <th>Devis</th>
                    </tr>
                </thead>
                <tbody id="clientsBody">
                    {% for client in clients %}
                    <tr class="client-row"
                        data-client-id="{{ client.id }}"
                        data-name="{{ client.full_name }}"
                        data-type="{{ client.type }}"
                        data-email="{{ client.email }}"
                        data-cell="{{ client.phone }}"
                        data-address="{{ client.postal_address }}">
                        <td>
                            <div class="client-cell">
                                <div class="avatar avatar-sm">
                                    {{ client.firstName|first }}{{ client.lastName|first }}
                                </div>
                                <div>
                                    <div class="cell-primary">{{ client.full_name }}</div>
                                    <div class="cell-secondary">{{ client.type }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="cell-email">{{ client.email|default:"-" }}</td>
                        <td>{{ client.phone|default:"-" }}</td>
                        <td>{{ client.postal_address|default:"-" }}</td>
                        <td>
                            <span class="count-badge">{{ client.demande_set.count }}</span>
                        </td>
                        <td>
                            <span class="count-badge">{{ client.devis_set.count }}</span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                </svg>
                            </div>
                            <p>Aucun client pour le moment</p>
                            <button class="btn btn-primary btn-sm" data-modal-target="#modalClient">Ajouter un client</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- PANNEAU LATÉRAL DROIT : DÉTAIL CLIENT -->
    <div class="side-panel" id="sidePanel">
        <div class="side-panel-header">
            <div class="side-panel-title">Détail client</div>
            <button class="side-panel-close" id="closeSidePanel">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="side-panel-body" id="sidePanelBody">
            <div class="side-panel-loader" id="sidePanelLoader">
                <div class="spinner"></div>
                <span>Chargement...</span>
            </div>
            <div class="side-panel-content" id="sidePanelContent" style="display:none;"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    var pageWrapper  = document.getElementById('pageWrapper');
    var sidePanel    = document.getElementById('sidePanel');
    var closeBtn     = document.getElementById('closeSidePanel');
    var loader       = document.getElementById('sidePanelLoader');
    var content      = document.getElementById('sidePanelContent');
    var rows         = document.querySelectorAll('.client-row');
    var searchInput  = document.getElementById('searchInput');
    var activeRow    = null;

    // ============================
    // CLIC SUR UN CLIENT
    // ============================
    rows.forEach(function(row) {
        row.addEventListener('click', function() {
            var clientId = this.getAttribute('data-client-id');

            if (activeRow === this && pageWrapper.classList.contains('panel-open')) {
                closePanel();
                return;
            }

            if (activeRow) activeRow.classList.remove('row-active');
            this.classList.add('row-active');
            activeRow = this;

            openPanel(clientId);
        });
    });

    // ============================
    // OUVRIR LE PANNEAU
    // ============================
    function openPanel(clientId) {
        pageWrapper.classList.add('panel-open');
        loader.style.display = 'flex';
        content.style.display = 'none';

        fetch('/api/client/' + clientId + '/')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                renderPanel(data);
                loader.style.display = 'none';
                content.style.display = 'block';
            })
            .catch(function(err) {
                console.error(err);
                content.innerHTML = '<div class="side-panel-error">Erreur de chargement</div>';
                loader.style.display = 'none';
                content.style.display = 'block';
            });
    }

    // ============================
    // FERMER LE PANNEAU
    // ============================
    function closePanel() {
        pageWrapper.classList.remove('panel-open');
        if (activeRow) activeRow.classList.remove('row-active');
        activeRow = null;
    }

    closeBtn.addEventListener('click', closePanel);

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closePanel();
    });

    // ============================
    // RENDU DU PANNEAU
    // ============================
    function renderPanel(data) {
        var initials = (data.firstName.charAt(0) + data.lastName.charAt(0)).toUpperCase();
        var html = '';

        // Profil
        html += '<div class="sp-profile">';
        html += '  <div class="avatar avatar-lg">' + initials + '</div>';
        html += '  <div class="sp-profile-info">';
        html += '    <h2 class="sp-name">' + data.firstName + ' ' + data.lastName + '</h2>';
        html += '    <span class="sp-date">' + data.type + '</span>';
        html += '  </div>';
        html += '</div>';

        // Coordonnées
        html += '<div class="sp-section">';
        html += '  <div class="sp-section-title">Coordonnées</div>';
        html += '  <div class="sp-fields">';
        html += renderField('Email', data.email || '—', 'email');
        html += renderField('Téléphone', data.phone || '—', 'phone');
        html += renderField('Adresse', data.postal_address || '—', 'address');
        html += '  </div>';
        html += '</div>';

        // Demandes
        html += '<div class="sp-section">';
        html += '  <div class="sp-section-header">';
        html += '    <div class="sp-section-title">Demandes</div>';
        html += '    <span class="count-badge">' + data.demandes.length + '</span>';
        html += '  </div>';

        if (data.demandes.length === 0) {
            html += '<div class="sp-empty">Aucune demande</div>';
        } else {
            data.demandes.forEach(function(d) {
                html += '<div class="sp-card">';
                html += '  <div class="sp-card-top">';
                html += '    <span class="sp-card-ref">' + (d.reference || 'Demande #' + d.id) + '</span>';
                html += '    <span class="status-badge status-' + slugify(d.type) + '">' + (d.type || '—') + '</span>';
                html += '  </div>';
                html += '  <div class="sp-card-bottom">';
                html += '    <span class="sp-card-amount">' + (d.montant ? d.montant.toLocaleString('fr-FR') + ' €' : '—') + '</span>';
                html += '    <span class="sp-card-date">' + (d.excpectedVisitDate || '—') + '</span>';
                html += '  </div>';
                if (d.description) {
                    html += '<div class="sp-card-desc">' + d.description + '</div>';
                }
                html += '</div>';
            });
        }
        html += '</div>';
        // Devis
        html += '<div class="sp-section">';
        html += '  <div class="sp-section-header">';
        html += '    <div class="sp-section-title">Devis</div>';
        html += '    <span class="count-badge">' + data.devis.length + '</span>';
        html += '  </div>';

        if (data.devis.length === 0) {
            html += '<div class="sp-empty">Aucun devis</div>';
        } else {
            data.devis.forEach(function(d) {
                html += '<div class="sp-card">';
                html += '  <div class="sp-card-top">';
                html += '    <span class="sp-card-ref">' + (d.reference || 'Devis #' + d.id) + '</span>';
                html += '    <span class="status-badge status-' + slugify(d.status) + '">' + (d.status || '—') + '</span>';
                html += '  </div>';
                html += '  <div class="sp-card-bottom">';
                html += '    <span class="sp-card-amount">' + (d.montant ? d.montant.toLocaleString('fr-FR') + ' €' : '—') + '</span>';
                html += '    <span class="sp-card-date">' + (d.datePrevisionEnvoi || '—') + '</span>';
                html += '  </div>';
                html += '</div>';
            });
        }
        html += '</div>';

        // Actions
        html += '<div class="sp-actions">';
        html += `  <button class="btn btn-primary btn-full" onclick="openEditClientModal(${data.id})">Modifier le client</button>`;
        html += '  <button class="btn btn-danger-ghost btn-full" onclick="openDeleteClientModal(' + data.id + ', \'' + data.firstName.replace(/'/g, "\\'") + ' ' + data.lastName.replace(/'/g, "\\'") + '\')">Supprimer</button>';
        html += '</div>';

        content.innerHTML = html;
    }

    function renderField(label, value, type) {
        var icons = {
            email: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>',
            phone: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
            address: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
            city: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>'
        };
        var icon = icons[type] || icons.city;
        return '<div class="sp-field"><div class="sp-field-icon">' + icon + '</div><div><div class="sp-field-label">' + label + '</div><div class="sp-field-value">' + value + '</div></div></div>';
    }

    function slugify(str) {
        if (!str) return 'default';
        return str.toLowerCase()
            .replace(/[àáâã]/g, 'a')
            .replace(/[éèêë]/g, 'e')
            .replace(/\s+/g, '-')
            .replace(/[^a-z0-9-]/g, '');
    }

    // ============================
    // RECHERCHE
    // ============================
    searchInput.addEventListener('input', function() {
        var q = this.value.toLowerCase();
        rows.forEach(function(row) {
            var name  = row.getAttribute('data-name').toLowerCase();
            var email = row.getAttribute('data-email').toLowerCase();
            var city  = (row.getAttribute('data-city') || '').toLowerCase();
            var match = name.includes(q) || email.includes(q) || city.includes(q);
            row.style.display = match ? '' : 'none';
        });
    });

});
</script>
{% endblock %}


{% block modals %}
    {% include "modals/client_form.html" %}
    {% include "modals/devis_form.html" %}
    {% include "modals/demande_form.html" %}
{% endblock %}

